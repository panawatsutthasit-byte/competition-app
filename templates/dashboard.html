{% extends "base.html" %}
{% block body_class %}dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard: ‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î + ‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏á */
  body.dashboard{
    --bg-top:#f8fbff; --bg-mid:#ffffff;
    background:
      radial-gradient(14px 14px at 24% 28%, rgba(13,110,253,.06) 22%, transparent 23%) repeat,
      radial-gradient(14px 14px at 76% 72%, rgba(32,201,151,.06) 22%, transparent 23%) repeat,
      linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 55%);
    background-size: 30px 30px, 30px 30px, auto;
  }

  /* Header ‡πÅ‡∏ö‡∏ö glass */
  .page-header{
    border-radius:.75rem;
    background:
      radial-gradient(800px 260px at 0% -20%, rgba(13,110,253,.06), transparent 60%),
      radial-gradient(600px 220px at 110% 0%, rgba(32,201,151,.06), transparent 70%),
      linear-gradient(180deg,#f7f9fc 0%, #fff 60%);
    border:1px solid rgba(0,0,0,.05);
  }

  .card.soft{ border:0; border-radius:1rem; box-shadow:0 .25rem 1rem rgba(0,0,0,.06); }

  /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á: ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å/‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î */
  .filter .input-group.input-group-sm .input-group-text{ background:#f8f9fa; }
  .btn-slim{ padding:.42rem .9rem; font-size:.95rem; border-radius:.6rem; }
  .chip{display:inline-flex; align-items:center; gap:.35rem; background:#f1f3f5; color:#495057;
        border:1px solid rgba(0,0,0,.08); border-radius:999px; padding:.25rem .6rem; font-size:.9rem;}

  /* KPI ‡∏Å‡∏≤‡∏£‡πå‡∏î */
  .kpi{ position:relative; overflow:hidden; }
  .kpi .icon{ width:40px; height:40px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; }
  .kpi .value{ font-size:2rem; line-height:1; font-weight:700; }
  .kpi--schools .icon{ background:rgba(13,110,253,.12); color:#0d6efd; }
  .kpi--participants .icon{ background:rgba(32,201,151,.12); color:#20c997; }
  .kpi--results .icon{ background:rgba(255,193,7,.18); color:#b8860b; }
  .kpi--complete .icon{ background:rgba(25,135,84,.15); color:#198754; }

  /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
  .table-hover tbody tr:hover{ background:#fafcff; }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Å‡∏£‡∏≤‡∏ü ‚Äì ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏π‡∏á‡∏¢‡∏≤‡∏ß */
  .chart-box{
    position:relative;
    height: 340px;   /* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
  }
  @media (max-width: 576px){
    .chart-box{ height: 260px; }
  }
</style>
{% endblock %}

{% block content %}

<!-- Header -->
<div class="page-header p-4 mb-4">
  <h3 class="mb-1"><i class="bi bi-speedometer2 text-primary me-2"></i>Dashboard ‡∏™‡∏£‡∏∏‡∏õ</h3>
  <p class="text-muted mb-0">‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ß‡∏°</p>
</div>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
<div class="card soft mb-4">
  <div class="card-body">
    <h6 class="card-title mb-3 text-secondary"><i class="bi bi-funnel me-2"></i>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h6>
    <form method="get" class="row g-3 filter">
      <div class="col-md-3">
        <label class="form-label">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
          <input type="date" name="date_from" class="form-control" value="{{ date_from or '' }}">
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="bi bi-calendar2-event"></i></span>
          <input type="date" name="date_to" class="form-control" value="{{ date_to or '' }}">
        </div>
      </div>

      <div class="col-12 d-flex justify-content-end gap-2">
        <button class="btn btn-primary btn-slim"><i class="bi bi-funnel"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <a class="btn btn-outline-secondary btn-slim" href="{{ url_for('dashboard') }}"><i class="bi bi-x-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</a>
      </div>

      {% if date_from or date_to %}
      <div class="col-12">
        <span class="chip"><i class="bi bi-calendar-week"></i>
          {% if date_from %}‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà {{ date_from }}{% endif %}
          {% if date_from and date_to %} ‡∏ñ‡∏∂‡∏á {% endif %}
          {% if date_to %}{{ date_to }}{% endif %}
        </span>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<!-- KPI ‡∏´‡∏•‡∏±‡∏Å -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card soft p-3 kpi kpi--schools">
      <div class="d-flex align-items-center gap-3">
        <div class="icon"><i class="bi bi-building"></i></div>
        <div>
          <div class="text-muted small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
          <div class="value">{{ total_schools }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card soft p-3 kpi kpi--participants">
      <div class="d-flex align-items-center gap-3">
        <div class="icon"><i class="bi bi-people"></i></div>
        <div>
          <div class="text-muted small">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="value">{{ total_participants }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card soft p-3 kpi kpi--results">
      <div class="d-flex align-items-center gap-3">
        <div class="icon"><i class="bi bi-trophy"></i></div>
        <div>
          <div class="text-muted small">‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
          <div class="value">{{ results_count }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card soft p-3 kpi kpi--complete">
      <div class="d-flex align-items-center gap-3">
        <div class="icon"><i class="bi bi-patch-check"></i></div>
        <div>
          <div class="text-muted small">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏• (%)</div>
          <div class="value">{{ completion_pct }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
<div class="card soft p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <b>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</b>
    <span class="text-muted small">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏Ñ‡∏ô / ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
  </div>
  <!-- ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà height ‡∏ö‡∏ô canvas -->
  <div class="chart-box">
    <canvas id="catChart"></canvas>
  </div>
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
<div class="card soft mb-4">
  <div class="card-body">
    <h6 class="card-title mb-3 text-secondary"><i class="bi bi-grid me-2"></i>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h6>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th style="width:14rem">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
            <th style="width:14rem">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
          </tr>
        </thead>
        <tbody>
          {% for r in by_category %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.schools }}</td>
              <td>{{ r.participants }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Top 5 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç -->
  <div class="col-lg-7">
    <div class="card soft h-100">
      <div class="card-body">
        <h6 class="card-title mb-3 text-secondary"><i class="bi bi-trophy-fill me-2 text-warning"></i>Top 5 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</h6>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>ü•á</th><th>ü•à</th><th>ü•â</th><th>‡∏£‡∏ß‡∏°</th></tr>
            </thead>
            <tbody>
              {% if top_schools %}
                {% for s in top_schools %}
                <tr>
                  <td>{{ s.school }}</td>
                  <td>{{ s.gold }}</td>
                  <td>{{ s.silver }}</td>
                  <td>{{ s.bronze }}</td>
                  <td>{{ s.total }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="5" class="text-muted text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•) -->
  <div class="col-lg-5">
    <div class="card soft h-100">
      <div class="card-body">
        <h6 class="card-title mb-3 text-secondary"><i class="bi bi-hourglass-split me-2"></i>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏• ({{ pending_count }})</h6>
        <ul class="list-group">
          {% if pending_list %}
            {% for p in pending_list %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div><b>{{ p.fullname }}</b></div>
                  <div class="small text-muted">{{ p.school }} ‚Ä¢ {{ p.category }}</div>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted">‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å üéâ</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
  const catLabels    = JSON.parse('{{ cat_labels|tojson|safe }}');
  const catCounts    = JSON.parse('{{ cat_counts|tojson|safe }}');    // ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
  const schoolCounts = JSON.parse('{{ school_counts|tojson|safe }}'); // ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô

  const ctx = document.getElementById('catChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: catLabels,
      datasets: [
        { label: '‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°', data: catCounts, backgroundColor: 'rgba(13,110,253,.35)', borderColor: 'rgba(13,110,253,.8)', borderWidth: 1 },
        { label: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°', data: schoolCounts, backgroundColor: 'rgba(32,201,151,.35)', borderColor: 'rgba(32,201,151,.8)', borderWidth: 1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,   // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å .chart-box
      resizeDelay: 120,
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
      plugins: { legend: { position: 'top' } }
    }
  });
</script>
{% endblock %}
